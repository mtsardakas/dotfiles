_HiStOrY_V2_
Select\040*\040from\040intl.titles\040where\040primary_title_no\040=\040963310;
Select\040primary_title_no,\040ter_id,\040release_date,\040distributor\040\040from\040intl.titles\040where\040primary_title_no\040=\040963310;
Select\040primary_title_no,\040ter_id,\040release_date,\040distributor\040\040from\040intl.titles\040where\040primary_title_no\040=\040982716;
Select\040primary_title_no,\040ter_id,\040release_date,\040distributor,\040title\040\040from\040intl.titles\040where\040ter_id\040=\040KR\040and\040primary_title_no\040=\040982716;
Select\040primary_title_no,\040ter_id,\040release_date,\040distributor,\040title\040\040from\040intl.titles\040where\040ter_id\040=\040'KR'\040and\040primary_title_no\040=\040982716;
Select\040primary_title_no,\040ter_id,\040release_date,\040distributor,\040title\040\040from\040intl.titles\040where\040ter_id\040=\040'KR'\040and\040primary_title_no\040=\040963310;
SELECT\040*\040FROM\040analyst.day_profiles\040where\040filename\040ilike\040'%Eris%'\040and\040ter_id\040=\040'WA'\040\^A;
SELECT\040*\040FROM\040analyst.day_profiles\040where\040filename\040ilike\040'%Eris%'\040and\040ter_id\040=\040'WA';
SELECT\040*\040FROM\040analyst.day_profiles\040where\040filename\040ilike\040'%Eris%'\040and\040ter_id\040=\040'WA'\040and\040time_updated::date\040>=\040'2023-10-31'\040;
SELECT\040*\040FROM\040analyst.day_profiles\040where\040filename\040ilike\040'%Eris%'\040and\040ter_id\040=\040'WA'\040and\040time_updated::date\040>=\040'2023-10-31'\040order\040by\040date\040desc;
SELECT\040*\040FROM\040analyst.day_profiles\040where\040filename\040ilike\040'%Eris%'\040and\040ter_id\040=\040'WA'\040and\040time_updated::date\040>=\040'2023-10-31'\040order\040by\040date\040asc;
begin;
DELETE\040FROM\040analyst.day_profiles\040where\040filename\040ilike\040'%Eris%'\040and\040ter_id\040=\040'WA'\040and\040time_updated::date\040>=\040'2023-10-31';
SELECT\040*\040FROM\040analyst.day_profiles\040where\040filename\040ilike\040'%Eris%'\040and\040ter_id\040=\040'WA'\040and\040time_updated::date\040>=\040'2023-10-31'\^A;
commit;
SELECT\040*\040FROM\040releases\040where\040release_date\040is\040null;
SELECT\040*\040FROM\040intl.releases\040where\040release_date\040is\040null;
SELECT\040*\040FROM\040intl.releases\040where\040release_date\040is\040null\040limit\04010;
SELECT\040*\040FROM\040intl.titles\040\040where\040release_date\040is\040null\040limit\04010;
\134d+\040intl.titles
SELECT\040*\040FROM\040wknd_3_weeks\040limit\0401;
TRUNCATE\040TABLE\040wknd_3_weeks;
SELECT\040*\040FROM\040wknd_3_weeks\040limit\0401;
ALTER\040TABLE\040wknd_3_weeks\040ADD\040COLUMN\040updated_at\040TIMESTAMP;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405\^A;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405;
ALTER\040MATERIALIZED\040VIEW\040dom.transaction_theater_totals\040OWNER\040TO\040rentrakfeed;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405;
SELECT\040n.nspname\040AS\040schema_name,\040m.matviewname\040AS\040matview_name,\040m.matviewowner\040AS\040owner\^AFROM\040pg_matviews\040m\^AJOIN\040pg_namespace\040n\040ON\040m.schemaname\040=\040n.nspname\^AWHERE\040m.matviewname\040=\040'transaction_theater_totals';
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\0405;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040order\040by\040gross\040desc\040limit\0405;
SELECT\040*\040FROM\040forecast_app.scenarios\040where\040user_id\040=\040'3'\040\040and\040created_date::date\040=\040CURRENT_DATE::date\040+\040interval\040'-1\040day'\040order\040by\040updated_date\040limit\040100\^ASELECT\040*\040FROM\040dom.transaction_theater_totals\040order\040by\040gross\040desc\040limit\04050;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\04050;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\040500;
SELECT\040*\040FROM\040dom.transaction_theater_totals\040limit\040500;
ALTER\040TABLE\040forecast_app.dailies\^AADD\040COLUMN\040next_sunday\040DATE\040GENERATED\040ALWAYS\040AS\040(\^A\040\040\040\040CASE\^A\040\040\040\040\040\040\040\040WHEN\040EXTRACT(DOW\040FROM\040date)\040=\0400\040THEN\040date\^A\040\040\040\040\040\040\040\040ELSE\040date\040+\040(7\040-\040EXTRACT(DOW\040FROM\040date))\040*\040INTERVAL\040'1\040day'\^A\040\040\040\040END\^A)\040STORED;
ALTER\040TABLE\040forecast_app.dailies\^AADD\040COLUMN\040next_sunday\040DATE\040GENERATED\040ALWAYS\040AS\040(\^A\040\040\040\040CASE\^A\040\040\040\040\040\040\040\040WHEN\040EXTRACT(DOW\040FROM\040date)\040=\0400\040THEN\040date\^A\040\040\040\040\040\040\040\040ELSE\040date\040+\040(7\040-\040EXTRACT(DOW\040FROM\040date))\040*\040INTERVAL\040'1\040day'\^A\040\040\040\040END\^A)\040STORED\^A;
\134d+\040forecast_app.dailies
ALTER\040TABLE\040forecast_app.dailies\^AADD\040COLUMN\040wknd_report_sunday\040DATE\040GENERATED\040ALWAYS\040AS\040(\^A\040\040\040\040CASE\^A\040\040\040\040\040\040\040\040WHEN\040EXTRACT(DOW\040FROM\040date)\040=\0400\040THEN\040date\^A\040\040\040\040\040\040\040\040ELSE\040date\040+\040(7\040-\040EXTRACT(DOW\040FROM\040date))\040*\040INTERVAL\040'1\040day'\^A\040\040\040\040END\^A)\040STORED;
ALTER\040TABLE\040forecast_app.dailies\^AADD\040COLUMN\040wknd_report_sunday\040DATE\040GENERATED\040ALWAYS\040AS\040(\^A\040\040\040\040CASE\^A\040\040\040\040\040\040\040\040WHEN\040EXTRACT(DOW\040FROM\040date)\040=\0400\040THEN\040date\^A\040\040\040\040\040\040\040\040ELSE\040date\040+\040(7\040-\040EXTRACT(DOW\040FROM\040date))\040*\040INTERVAL\040'1\040day'\^A\040\040\040\040END\^A)\040STORED;
CREATE\040INDEX\040idx_report_sunday\040\^AON\040forecast_app.dailies\040(\^A\040\040\040\040wknd_report_sunday\^A);
DROP\040INDEX\040IF\040EXISTS\040dailies_primary_title_no_ter_id_idx;
CREATE\040INDEX\040dailies_primary_title_no_ter_id_idx\^AON\040your_table_name\040(primary_title_no,\040ter_id)\^AINCLUDE\040(cume)\^AWHERE\040is_lifetime;
DROP\040INDEX\040IF\040EXISTS\040forecast_app.dailies_primary_title_no_ter_id_idx;
CREATE\040INDEX\040dailies_primary_title_no_ter_id_idx\^AON\040forecast_app.dailies\040(ter_id,\040primary_title_no)\^AINCLUDE\040(cume)\^AWHERE\040is_lifetime;
\134d+\040forecast_app.dailies
ANALYZE\040forecast_app.dailies;
CREATE\040INDEX\040idx_dailies_sort_optimization\^AON\040forecast_app.dailies\040(ter_id,\040primary_title_no,\040wknd_report_sunday,\040value\040DESC,\040cume\040DESC)\^AWHERE\040currency\040=\040'USD'\040AND\040type\040IN\040(2,4);
CREATE\040INDEX\040idx_dailies_sort_optimization\^AON\040forecast_app.dailies\040(ter_id,\040primary_title_no,\040wknd_report_sunday,\040value\040DESC,\040cume\040DESC)\^AWHERE\040currency\040=\040'USD'\040AND\040type\040IN\040(2,4);
CREATE\040INDEX\040idx_dailies_cte_optimization\040\^AON\040forecast_app.dailies\040(ter_id,\040primary_title_no,\040wknd_report_sunday,\040date,\040is_weekend,\040type,\040currency,\040value,\040cume)\^AWHERE\040currency\040=\040'USD'\040AND\040type\040IN\040(2,4);
ANALYZE\040forecast_app.dailies;
SELECT\^A\040\040\040\040indexrelname\040AS\040index_name,\^A\040\040\040\040idx_scan\040AS\040total_scans,\^A\040\040\040\040idx_tup_read\040AS\040tuples_read,\^A\040\040\040\040idx_tup_fetch\040AS\040tuples_fetched\^AFROM\^A\040\040\040\040pg_stat_user_indexes\^AWHERE\^A\040\040\040\040relname\040=\040'dailies'\^A\040\040\040\040AND\040schemaname\040=\040'forecast_app'\^AORDER\040BY\^A\040\040\040\040total_scans\040DESC;
SET\040enable_seqscan\040=\040OFF;
SET\040enable_indexscan\040=\040ON;
SELECT\^A\040\040\040\040attname,\^A\040\040\040\040n_distinct,\^A\040\040\040\040most_common_vals,\^A\040\040\040\040most_common_freqs\^AFROM\^A\040\040\040\040pg_stats\^AWHERE\^A\040\040\040\040tablename\040=\040'dailies';
EXPLAIN\040(ANALYZE,\040COSTS,\040VERBOSE,\040BUFFERS,\040FORMAT\040JSON)\^AWITH\040week\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040MIN(week)\040AS\040week,\^A\040\040\040\040\040\040\040\040MAX(film_week)\040AS\040film_week,\^A\040\040\040\040\040\040\040\040wknd_report_sunday,\^A\040\040\040\040\040\040\040\040SUM(value)\040FILTER\040(WHERE\040is_weekend)\040AS\040wknd,\^A\040\040\040\040\040\040\040\040JSONB_OBJECT_AGG(to_char(date,\040'Dy')::text,\040value)\040AS\040dailies,\^A\040\040\040\040\040\040\040\040MAX(cume)\040AS\040cume,\^A\040\040\040\040\040\040\040\040MIN(cume\040-\040value)\040AS\040last_wknd_cume\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040true\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040date\040<=\040wknd_report_sunday\^A\040\040\040\040\040\040AND\040date\040>\040wknd_report_sunday\040+\040INTERVAL\040'-1\040week'\^A\040\040\040\040GROUP\040BY\040ter_id,\040primary_title_no,\040wknd_report_sunday\^A),\040\^Alast_week\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040SUM(value)\040FILTER\040(WHERE\040is_weekend)\040AS\040wknd\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040true\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040dailies.date\040<=\040wknd_report_sunday\040+\040INTERVAL\040'-1\040week'\^A\040\040\040\040\040\040AND\040dailies.date\040>\040wknd_report_sunday\040+\040INTERVAL\040'-2\040weeks'\^A\040\^A\040\040\040\040GROUP\040BY\040ter_id,\040primary_title_no,\040wknd_report_sunday\^A),\^Alifetimes\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040cume\040as\040base\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040is_lifetime\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\^A)\^ASELECT\^AROW_NUMBER()\040OVER\040(PARTITION\040BY\040week.ter_id\^A\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040ORDER\040BY\040COALESCE(week.wknd,\0400)\040DESC,\040COALESCE(lifetimes.base,\0400))\040AS\040RANK,\^A\040\040\040\040week.ter_id,\^A\040\040\040\040week.primary_title_no,\^A\040\040\040\040week.wknd,\^A\040\040\040\040last_week.wknd\040AS\040last_wknd,\^A\040\040\040\040week.cume,\^A\040\040\040\040week.last_wknd_cume\040AS\040last_wknd_cume,\^A\040\040\040\040COALESCE(week.dailies->>'Mon',\040'0')::numeric\040AS\040MON,\^A\040\040\040\040COALESCE(week.dailies->>'Tue',\040'0')::numeric\040AS\040TUE,\^A\040\040\040\040COALESCE(week.dailies->>'Wed',\040'0')::numeric\040AS\040WED,\^A\040\040\040\040COALESCE(week.dailies->>'Thu',\040'0')::numeric\040AS\040THU,\^A\040\040\040\040COALESCE(week.dailies->>'Fri',\040'0')::numeric\040AS\040FRI,\^A\040\040\040\040COALESCE(week.dailies->>'Sat',\040'0')::numeric\040AS\040SAT,\^A\040\040\040\040COALESCE(week.dailies->>'Sun',\040'0')::numeric\040AS\040SUN,\^A\040\040\040\040COALESCE(lifetimes.base,\0400)\040AS\040life,\^A\040\040\040\040CONCAT('(',\040ARRAY_TO_STRING(ARRAY[\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040=\0401\040THEN\040'Mon'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0402\040THEN\040'Tue'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0403\040THEN\040'Wed'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0404\040THEN\040'Thu'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0405\040THEN\040'Fri'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0406\040THEN\040'Sat'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0407\040THEN\040'Sun'\040END\^A\040\040\040\040],\040',\040'),\040')')\040AS\040days_in_weekend,\^A\040\040\040\040week.week\040AS\040weeks_out,\^A\040\040\040\040week.film_week\040AS\040wk,\^A\040\040\040\040week.wknd_report_sunday\040AS\040report_sunday,\^A\040\040\040\040territory.country_name\040AS\040terr_name,\^A\040\040\040\040metadata.international_title,\^A\040\040\040\040metadata.title,\^A\040\040\040\040metadata.distributor,\^A\040\040\040\040rating,\040release_date\^AFROM\040week\^ALEFT\040JOIN\040last_week\040ON\040week.ter_id\040=\040last_week.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040last_week.primary_title_no\040\^AINNER\040JOIN\040common.territory_group\040ON\040week.ter_id\040=\040territory_group.ter_id\^AINNER\040JOIN\040common.territory\040ON\040territory.country_code\040=\040territory_group.ter_id\^AINNER\040JOIN\040lifetimes\040ON\040week.ter_id\040=\040lifetimes.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040lifetimes.primary_title_no\^ALEFT\040JOIN\040forecast_app.metadata\040ON\040week.ter_id\040=\040metadata.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040metadata.primary_title_no\^AWHERE\040territory.source\040=\040'flash'\^A\040\040AND\040territory_group.id\040=\040'GLOBAL'\^A\040\040AND\040week.wknd\040>\0400\^AORDER\040BY\040week.wknd_report_sunday,\040week.ter_id,\040week.wknd\040DESC,\040lifetimes.base\040DESC;
EXPLAIN\040(ANALYZE,\040COSTS,\040VERBOSE,\040BUFFERS,\040FORMAT\040JSON)\^AWITH\040week\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040MIN(week)\040AS\040week,\^A\040\040\040\040\040\040\040\040MAX(film_week)\040AS\040film_week,\^A\040\040\040\040\040\040\040\040wknd_report_sunday,\^A\040\040\040\040\040\040\040\040SUM(value)\040FILTER\040(WHERE\040is_weekend)\040AS\040wknd,\^A\040\040\040\040\040\040\040\040JSONB_OBJECT_AGG(to_char(date,\040'Dy')::text,\040value)\040AS\040dailies,\^A\040\040\040\040\040\040\040\040MAX(cume)\040AS\040cume,\^A\040\040\040\040\040\040\040\040MIN(cume\040-\040value)\040AS\040last_wknd_cume\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040true\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040date\040<=\040wknd_report_sunday\^A\040\040\040\040\040\040AND\040date\040>\040wknd_report_sunday\040+\040INTERVAL\040'-1\040week'\^A\040\040\040\040GROUP\040BY\040ter_id,\040primary_title_no,\040wknd_report_sunday\^A),\040\^Alast_week\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040SUM(value)\040FILTER\040(WHERE\040is_weekend)\040AS\040wknd\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040true\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040dailies.date\040<=\040wknd_report_sunday\040+\040INTERVAL\040'-1\040week'\^A\040\040\040\040\040\040AND\040dailies.date\040>\040wknd_report_sunday\040+\040INTERVAL\040'-2\040weeks'\^A\040\^A\040\040\040\040GROUP\040BY\040ter_id,\040primary_title_no,\040wknd_report_sunday\^A),\^Alifetimes\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040cume\040as\040base\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040is_lifetime\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\^A),\^Awknd\040AS\040(\^ASELECT\^AROW_NUMBER()\040OVER\040(PARTITION\040BY\040week.ter_id\^A\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040ORDER\040BY\040COALESCE(week.wknd,\0400)\040DESC,\040COALESCE(lifetimes.base,\0400))\040AS\040RANK,\^A\040\040\040\040week.ter_id,\^A\040\040\040\040week.primary_title_no,\^A\040\040\040\040week.wknd,\^A\040\040\040\040last_week.wknd\040AS\040last_wknd,\^A\040\040\040\040week.cume,\^A\040\040\040\040week.last_wknd_cume\040AS\040last_wknd_cume,\^A\040\040\040\040COALESCE(week.dailies->>'Mon',\040'0')::numeric\040AS\040MON,\^A\040\040\040\040COALESCE(week.dailies->>'Tue',\040'0')::numeric\040AS\040TUE,\^A\040\040\040\040COALESCE(week.dailies->>'Wed',\040'0')::numeric\040AS\040WED,\^A\040\040\040\040COALESCE(week.dailies->>'Thu',\040'0')::numeric\040AS\040THU,\^A\040\040\040\040COALESCE(week.dailies->>'Fri',\040'0')::numeric\040AS\040FRI,\^A\040\040\040\040COALESCE(week.dailies->>'Sat',\040'0')::numeric\040AS\040SAT,\^A\040\040\040\040COALESCE(week.dailies->>'Sun',\040'0')::numeric\040AS\040SUN,\^A\040\040\040\040COALESCE(lifetimes.base,\0400)\040AS\040life,\^A\040\040\040\040CONCAT('(',\040ARRAY_TO_STRING(ARRAY[\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040=\0401\040THEN\040'Mon'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0402\040THEN\040'Tue'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0403\040THEN\040'Wed'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0404\040THEN\040'Thu'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0405\040THEN\040'Fri'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0406\040THEN\040'Sat'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0407\040THEN\040'Sun'\040END\^A\040\040\040\040],\040',\040'),\040')')\040AS\040days_in_weekend,\^A\040\040\040\040week.week\040AS\040weeks_out,\^A\040\040\040\040week.film_week\040AS\040wk,\^A\040\040\040\040week.wknd_report_sunday\040AS\040report_sunday,\^A\040\040\040\040territory.country_name\040AS\040terr_name,\^A\040\040\040\040metadata.international_title,\^A\040\040\040\040metadata.title,\^A\040\040\040\040metadata.distributor,\^A\040\040\040\040rating,\040release_date\^AFROM\040week\^ALEFT\040JOIN\040last_week\040ON\040week.ter_id\040=\040last_week.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040last_week.primary_title_no\040\^AINNER\040JOIN\040common.territory_group\040ON\040week.ter_id\040=\040territory_group.ter_id\^AINNER\040JOIN\040common.territory\040ON\040territory.country_code\040=\040territory_group.ter_id\^AINNER\040JOIN\040lifetimes\040ON\040week.ter_id\040=\040lifetimes.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040lifetimes.primary_title_no\^ALEFT\040JOIN\040forecast_app.metadata\040ON\040week.ter_id\040=\040metadata.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040metadata.primary_title_no\^AWHERE\040territory.source\040=\040'flash'\^A\040\040AND\040territory_group.id\040=\040'GLOBAL'\^A\040\040AND\040week.wknd\040>\0400\^AORDER\040BY\040week.wknd_report_sunday,\040week.ter_id,\040week.wknd\040DESC,\040lifetimes.base\040DESC\^A)\^ASELECT\040*\040FROM\040wknd\040where\040report_sunday\040=\040'2024-12-08'\040and\040ter_id\040=\040'UK';
WITH\040week\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040MIN(week)\040AS\040week,\^A\040\040\040\040\040\040\040\040MAX(film_week)\040AS\040film_week,\^A\040\040\040\040\040\040\040\040wknd_report_sunday,\^A\040\040\040\040\040\040\040\040SUM(value)\040FILTER\040(WHERE\040is_weekend)\040AS\040wknd,\^A\040\040\040\040\040\040\040\040JSONB_OBJECT_AGG(to_char(date,\040'Dy')::text,\040value)\040AS\040dailies,\^A\040\040\040\040\040\040\040\040MAX(cume)\040AS\040cume,\^A\040\040\040\040\040\040\040\040MIN(cume\040-\040value)\040AS\040last_wknd_cume\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040true\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040date\040<=\040wknd_report_sunday\^A\040\040\040\040\040\040AND\040date\040>\040wknd_report_sunday\040+\040INTERVAL\040'-1\040week'\^A\040\040\040\040GROUP\040BY\040ter_id,\040primary_title_no,\040wknd_report_sunday\^A),\040\^Alast_week\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040SUM(value)\040FILTER\040(WHERE\040is_weekend)\040AS\040wknd\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040true\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040dailies.date\040<=\040wknd_report_sunday\040+\040INTERVAL\040'-1\040week'\^A\040\040\040\040\040\040AND\040dailies.date\040>\040wknd_report_sunday\040+\040INTERVAL\040'-2\040weeks'\^A\040\^A\040\040\040\040GROUP\040BY\040ter_id,\040primary_title_no,\040wknd_report_sunday\^A),\^Alifetimes\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040cume\040as\040base\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040is_lifetime\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\^A),\^Awknd\040AS\040(\^ASELECT\^AROW_NUMBER()\040OVER\040(PARTITION\040BY\040week.ter_id\^A\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040ORDER\040BY\040COALESCE(week.wknd,\0400)\040DESC,\040COALESCE(lifetimes.base,\0400))\040AS\040RANK,\^A\040\040\040\040week.ter_id,\^A\040\040\040\040week.primary_title_no,\^A\040\040\040\040week.wknd,\^A\040\040\040\040last_week.wknd\040AS\040last_wknd,\^A\040\040\040\040week.cume,\^A\040\040\040\040week.last_wknd_cume\040AS\040last_wknd_cume,\^A\040\040\040\040COALESCE(week.dailies->>'Mon',\040'0')::numeric\040AS\040MON,\^A\040\040\040\040COALESCE(week.dailies->>'Tue',\040'0')::numeric\040AS\040TUE,\^A\040\040\040\040COALESCE(week.dailies->>'Wed',\040'0')::numeric\040AS\040WED,\^A\040\040\040\040COALESCE(week.dailies->>'Thu',\040'0')::numeric\040AS\040THU,\^A\040\040\040\040COALESCE(week.dailies->>'Fri',\040'0')::numeric\040AS\040FRI,\^A\040\040\040\040COALESCE(week.dailies->>'Sat',\040'0')::numeric\040AS\040SAT,\^A\040\040\040\040COALESCE(week.dailies->>'Sun',\040'0')::numeric\040AS\040SUN,\^A\040\040\040\040COALESCE(lifetimes.base,\0400)\040AS\040life,\^A\040\040\040\040CONCAT('(',\040ARRAY_TO_STRING(ARRAY[\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040=\0401\040THEN\040'Mon'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0402\040THEN\040'Tue'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0403\040THEN\040'Wed'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0404\040THEN\040'Thu'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0405\040THEN\040'Fri'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0406\040THEN\040'Sat'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0407\040THEN\040'Sun'\040END\^A\040\040\040\040],\040',\040'),\040')')\040AS\040days_in_weekend,\^A\040\040\040\040week.week\040AS\040weeks_out,\^A\040\040\040\040week.film_week\040AS\040wk,\^A\040\040\040\040week.wknd_report_sunday\040AS\040report_sunday,\^A\040\040\040\040territory.country_name\040AS\040terr_name,\^A\040\040\040\040metadata.international_title,\^A\040\040\040\040metadata.title,\^A\040\040\040\040metadata.distributor,\^A\040\040\040\040rating,\040release_date\^AFROM\040week\^ALEFT\040JOIN\040last_week\040ON\040week.ter_id\040=\040last_week.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040last_week.primary_title_no\040\^AINNER\040JOIN\040common.territory_group\040ON\040week.ter_id\040=\040territory_group.ter_id\^AINNER\040JOIN\040common.territory\040ON\040territory.country_code\040=\040territory_group.ter_id\^AINNER\040JOIN\040lifetimes\040ON\040week.ter_id\040=\040lifetimes.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040lifetimes.primary_title_no\^ALEFT\040JOIN\040forecast_app.metadata\040ON\040week.ter_id\040=\040metadata.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040metadata.primary_title_no\^AWHERE\040territory.source\040=\040'flash'\^A\040\040AND\040territory_group.id\040=\040'GLOBAL'\^A\040\040AND\040week.wknd\040>\0400\^AORDER\040BY\040week.wknd_report_sunday,\040week.ter_id,\040week.wknd\040DESC,\040lifetimes.base\040DESC\^A)\^ASELECT\040*\040FROM\040wknd\040where\040report_sunday\040=\040'2024-12-08'\040and\040ter_id\040=\040'UK';
EXPLAIN\040(ANALYZE,\040COSTS,\040VERBOSE,\040BUFFERS,\040FORMAT\040JSON)\^AWITH\040week\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040MIN(week)\040AS\040week,\^A\040\040\040\040\040\040\040\040MAX(film_week)\040AS\040film_week,\^A\040\040\040\040\040\040\040\040wknd_report_sunday,\^A\040\040\040\040\040\040\040\040SUM(value)\040FILTER\040(WHERE\040is_weekend)\040AS\040wknd,\^A\040\040\040\040\040\040\040\040JSONB_OBJECT_AGG(to_char(date,\040'Dy')::text,\040value)\040AS\040dailies,\^A\040\040\040\040\040\040\040\040MAX(cume)\040AS\040cume,\^A\040\040\040\040\040\040\040\040MIN(cume\040-\040value)\040AS\040last_wknd_cume\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040true\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040date\040<=\040wknd_report_sunday\^A\040\040\040\040\040\040AND\040date\040>\040wknd_report_sunday\040+\040INTERVAL\040'-1\040week'\^A\040\040\040\040GROUP\040BY\040ter_id,\040primary_title_no,\040wknd_report_sunday\^A),\040\^Alast_week\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040SUM(value)\040FILTER\040(WHERE\040is_weekend)\040AS\040wknd\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040true\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040dailies.date\040<=\040wknd_report_sunday\040+\040INTERVAL\040'-1\040week'\^A\040\040\040\040\040\040AND\040dailies.date\040>\040wknd_report_sunday\040+\040INTERVAL\040'-2\040weeks'\^A\040\^A\040\040\040\040GROUP\040BY\040ter_id,\040primary_title_no,\040wknd_report_sunday\^A),\^Alifetimes\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040cume\040as\040base\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040is_lifetime\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\^A),\^Awknd\040AS\040(\^ASELECT\^AROW_NUMBER()\040OVER\040(PARTITION\040BY\040week.ter_id\^A\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040ORDER\040BY\040COALESCE(week.wknd,\0400)\040DESC,\040COALESCE(lifetimes.base,\0400))\040AS\040RANK,\^A\040\040\040\040week.ter_id,\^A\040\040\040\040week.primary_title_no,\^A\040\040\040\040week.wknd,\^A\040\040\040\040last_week.wknd\040AS\040last_wknd,\^A\040\040\040\040week.cume,\^A\040\040\040\040week.last_wknd_cume\040AS\040last_wknd_cume,\^A\040\040\040\040COALESCE(week.dailies->>'Mon',\040'0')::numeric\040AS\040MON,\^A\040\040\040\040COALESCE(week.dailies->>'Tue',\040'0')::numeric\040AS\040TUE,\^A\040\040\040\040COALESCE(week.dailies->>'Wed',\040'0')::numeric\040AS\040WED,\^A\040\040\040\040COALESCE(week.dailies->>'Thu',\040'0')::numeric\040AS\040THU,\^A\040\040\040\040COALESCE(week.dailies->>'Fri',\040'0')::numeric\040AS\040FRI,\^A\040\040\040\040COALESCE(week.dailies->>'Sat',\040'0')::numeric\040AS\040SAT,\^A\040\040\040\040COALESCE(week.dailies->>'Sun',\040'0')::numeric\040AS\040SUN,\^A\040\040\040\040COALESCE(lifetimes.base,\0400)\040AS\040life,\^A\040\040\040\040CONCAT('(',\040ARRAY_TO_STRING(ARRAY[\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040=\0401\040THEN\040'Mon'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0402\040THEN\040'Tue'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0403\040THEN\040'Wed'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0404\040THEN\040'Thu'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0405\040THEN\040'Fri'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0406\040THEN\040'Sat'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0407\040THEN\040'Sun'\040END\^A\040\040\040\040],\040',\040'),\040')')\040AS\040days_in_weekend,\^A\040\040\040\040week.week\040AS\040weeks_out,\^A\040\040\040\040week.film_week\040AS\040wk,\^A\040\040\040\040week.wknd_report_sunday\040AS\040report_sunday,\^A\040\040\040\040territory.country_name\040AS\040terr_name,\^A\040\040\040\040metadata.international_title,\^A\040\040\040\040metadata.title,\^A\040\040\040\040metadata.distributor,\^A\040\040\040\040rating,\040release_date\^AFROM\040week\^ALEFT\040JOIN\040last_week\040ON\040week.ter_id\040=\040last_week.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040last_week.primary_title_no\040\^AINNER\040JOIN\040common.territory_group\040ON\040week.ter_id\040=\040territory_group.ter_id\^AINNER\040JOIN\040common.territory\040ON\040territory.country_code\040=\040territory_group.ter_id\^AINNER\040JOIN\040lifetimes\040ON\040week.ter_id\040=\040lifetimes.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040lifetimes.primary_title_no\^ALEFT\040JOIN\040forecast_app.metadata\040ON\040week.ter_id\040=\040metadata.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040metadata.primary_title_no\^AWHERE\040territory.source\040=\040'flash'\^A\040\040AND\040territory_group.id\040=\040'GLOBAL'\^A\040\040AND\040week.wknd\040>\0400\^AORDER\040BY\040week.wknd_report_sunday,\040week.ter_id,\040week.wknd\040DESC,\040lifetimes.base\040DESC\^A)\^ASELECT\040*\040FROM\040wknd\040where\040report_sunday\040=\040'2024-12-08'\040limit\0405;
WITH\040week\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040MIN(week)\040AS\040week,\^A\040\040\040\040\040\040\040\040MAX(film_week)\040AS\040film_week,\^A\040\040\040\040\040\040\040\040wknd_report_sunday,\^A\040\040\040\040\040\040\040\040SUM(value)\040FILTER\040(WHERE\040is_weekend)\040AS\040wknd,\^A\040\040\040\040\040\040\040\040JSONB_OBJECT_AGG(to_char(date,\040'Dy')::text,\040value)\040AS\040dailies,\^A\040\040\040\040\040\040\040\040MAX(cume)\040AS\040cume,\^A\040\040\040\040\040\040\040\040MIN(cume\040-\040value)\040AS\040last_wknd_cume\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040true\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040date\040<=\040wknd_report_sunday\^A\040\040\040\040\040\040AND\040date\040>\040wknd_report_sunday\040+\040INTERVAL\040'-1\040week'\^A\040\040\040\040GROUP\040BY\040ter_id,\040primary_title_no,\040wknd_report_sunday\^A),\040\^Alast_week\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040SUM(value)\040FILTER\040(WHERE\040is_weekend)\040AS\040wknd\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040true\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040dailies.date\040<=\040wknd_report_sunday\040+\040INTERVAL\040'-1\040week'\^A\040\040\040\040\040\040AND\040dailies.date\040>\040wknd_report_sunday\040+\040INTERVAL\040'-2\040weeks'\^A\040\^A\040\040\040\040GROUP\040BY\040ter_id,\040primary_title_no,\040wknd_report_sunday\^A),\^Alifetimes\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040cume\040as\040base\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040is_lifetime\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\^A),\^Awknd\040AS\040(\^ASELECT\^AROW_NUMBER()\040OVER\040(PARTITION\040BY\040week.ter_id\^A\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040ORDER\040BY\040COALESCE(week.wknd,\0400)\040DESC,\040COALESCE(lifetimes.base,\0400))\040AS\040RANK,\^A\040\040\040\040week.ter_id,\^A\040\040\040\040week.primary_title_no,\^A\040\040\040\040week.wknd,\^A\040\040\040\040last_week.wknd\040AS\040last_wknd,\^A\040\040\040\040week.cume,\^A\040\040\040\040week.last_wknd_cume\040AS\040last_wknd_cume,\^A\040\040\040\040COALESCE(week.dailies->>'Mon',\040'0')::numeric\040AS\040MON,\^A\040\040\040\040COALESCE(week.dailies->>'Tue',\040'0')::numeric\040AS\040TUE,\^A\040\040\040\040COALESCE(week.dailies->>'Wed',\040'0')::numeric\040AS\040WED,\^A\040\040\040\040COALESCE(week.dailies->>'Thu',\040'0')::numeric\040AS\040THU,\^A\040\040\040\040COALESCE(week.dailies->>'Fri',\040'0')::numeric\040AS\040FRI,\^A\040\040\040\040COALESCE(week.dailies->>'Sat',\040'0')::numeric\040AS\040SAT,\^A\040\040\040\040COALESCE(week.dailies->>'Sun',\040'0')::numeric\040AS\040SUN,\^A\040\040\040\040COALESCE(lifetimes.base,\0400)\040AS\040life,\^A\040\040\040\040CONCAT('(',\040ARRAY_TO_STRING(ARRAY[\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040=\0401\040THEN\040'Mon'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0402\040THEN\040'Tue'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0403\040THEN\040'Wed'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0404\040THEN\040'Thu'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0405\040THEN\040'Fri'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0406\040THEN\040'Sat'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0407\040THEN\040'Sun'\040END\^A\040\040\040\040],\040',\040'),\040')')\040AS\040days_in_weekend,\^A\040\040\040\040week.week\040AS\040weeks_out,\^A\040\040\040\040week.film_week\040AS\040wk,\^A\040\040\040\040week.wknd_report_sunday\040AS\040report_sunday,\^A\040\040\040\040territory.country_name\040AS\040terr_name,\^A\040\040\040\040metadata.international_title,\^A\040\040\040\040metadata.title,\^A\040\040\040\040metadata.distributor,\^A\040\040\040\040rating,\040release_date\^AFROM\040week\^ALEFT\040JOIN\040last_week\040ON\040week.ter_id\040=\040last_week.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040last_week.primary_title_no\040\^AINNER\040JOIN\040common.territory_group\040ON\040week.ter_id\040=\040territory_group.ter_id\^AINNER\040JOIN\040common.territory\040ON\040territory.country_code\040=\040territory_group.ter_id\^AINNER\040JOIN\040lifetimes\040ON\040week.ter_id\040=\040lifetimes.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040lifetimes.primary_title_no\^ALEFT\040JOIN\040forecast_app.metadata\040ON\040week.ter_id\040=\040metadata.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040metadata.primary_title_no\^AWHERE\040territory.source\040=\040'flash'\^A\040\040AND\040territory_group.id\040=\040'GLOBAL'\^A\040\040AND\040week.wknd\040>\0400\^AORDER\040BY\040week.wknd_report_sunday,\040week.ter_id,\040week.wknd\040DESC,\040lifetimes.base\040DESC\^A)\^ASELECT\040*\040FROM\040wknd\040where\040report_sunday\040=\040'2024-12-08'\040limit\0405;
WITH\040week\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040MIN(week)\040AS\040week,\^A\040\040\040\040\040\040\040\040MAX(film_week)\040AS\040film_week,\^A\040\040\040\040\040\040\040\040wknd_report_sunday,\^A\040\040\040\040\040\040\040\040SUM(value)\040FILTER\040(WHERE\040is_weekend)\040AS\040wknd,\^A\040\040\040\040\040\040\040\040JSONB_OBJECT_AGG(to_char(date,\040'Dy')::text,\040value)\040AS\040dailies,\^A\040\040\040\040\040\040\040\040MAX(cume)\040AS\040cume,\^A\040\040\040\040\040\040\040\040MIN(cume\040-\040value)\040AS\040last_wknd_cume\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040true\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040date\040<=\040wknd_report_sunday\^A\040\040\040\040\040\040AND\040date\040>\040wknd_report_sunday\040+\040INTERVAL\040'-1\040week'\^A\040\040\040\040GROUP\040BY\040ter_id,\040primary_title_no,\040wknd_report_sunday\^A),\040\^Alast_week\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040SUM(value)\040FILTER\040(WHERE\040is_weekend)\040AS\040wknd\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040true\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040dailies.date\040<=\040wknd_report_sunday\040+\040INTERVAL\040'-1\040week'\^A\040\040\040\040\040\040AND\040dailies.date\040>\040wknd_report_sunday\040+\040INTERVAL\040'-2\040weeks'\^A\040\^A\040\040\040\040GROUP\040BY\040ter_id,\040primary_title_no,\040wknd_report_sunday\^A),\^Alifetimes\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040cume\040as\040base\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040is_lifetime\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\^A),\^Awknd\040AS\040(\^ASELECT\^AROW_NUMBER()\040OVER\040(PARTITION\040BY\040week.ter_id\^A\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040ORDER\040BY\040COALESCE(week.wknd,\0400)\040DESC,\040COALESCE(lifetimes.base,\0400))\040AS\040RANK,\^A\040\040\040\040week.ter_id,\^A\040\040\040\040week.primary_title_no,\^A\040\040\040\040week.wknd,\^A\040\040\040\040last_week.wknd\040AS\040last_wknd,\^A\040\040\040\040week.cume,\^A\040\040\040\040week.last_wknd_cume\040AS\040last_wknd_cume,\^A\040\040\040\040COALESCE(week.dailies->>'Mon',\040'0')::numeric\040AS\040MON,\^A\040\040\040\040COALESCE(week.dailies->>'Tue',\040'0')::numeric\040AS\040TUE,\^A\040\040\040\040COALESCE(week.dailies->>'Wed',\040'0')::numeric\040AS\040WED,\^A\040\040\040\040COALESCE(week.dailies->>'Thu',\040'0')::numeric\040AS\040THU,\^A\040\040\040\040COALESCE(week.dailies->>'Fri',\040'0')::numeric\040AS\040FRI,\^A\040\040\040\040COALESCE(week.dailies->>'Sat',\040'0')::numeric\040AS\040SAT,\^A\040\040\040\040COALESCE(week.dailies->>'Sun',\040'0')::numeric\040AS\040SUN,\^A\040\040\040\040COALESCE(lifetimes.base,\0400)\040AS\040life,\^A\040\040\040\040CONCAT('(',\040ARRAY_TO_STRING(ARRAY[\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040=\0401\040THEN\040'Mon'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0402\040THEN\040'Tue'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0403\040THEN\040'Wed'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0404\040THEN\040'Thu'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0405\040THEN\040'Fri'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0406\040THEN\040'Sat'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0407\040THEN\040'Sun'\040END\^A\040\040\040\040],\040',\040'),\040')')\040AS\040days_in_weekend,\^A\040\040\040\040week.week\040AS\040weeks_out,\^A\040\040\040\040week.film_week\040AS\040wk,\^A\040\040\040\040week.wknd_report_sunday\040AS\040report_sunday,\^A\040\040\040\040territory.country_name\040AS\040terr_name,\^A\040\040\040\040metadata.international_title,\^A\040\040\040\040metadata.title,\^A\040\040\040\040metadata.distributor,\^A\040\040\040\040rating,\040release_date\^AFROM\040week\^ALEFT\040JOIN\040last_week\040ON\040week.ter_id\040=\040last_week.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040last_week.primary_title_no\040\^AINNER\040JOIN\040common.territory_group\040ON\040week.ter_id\040=\040territory_group.ter_id\^AINNER\040JOIN\040common.territory\040ON\040territory.country_code\040=\040territory_group.ter_id\^AINNER\040JOIN\040lifetimes\040ON\040week.ter_id\040=\040lifetimes.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040lifetimes.primary_title_no\^ALEFT\040JOIN\040forecast_app.metadata\040ON\040week.ter_id\040=\040metadata.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040metadata.primary_title_no\^AWHERE\040territory.source\040=\040'flash'\^A\040\040AND\040territory_group.id\040=\040'GLOBAL'\^A\040\040\^AORDER\040BY\040week.wknd_report_sunday,\040week.ter_id,\040week.wknd\040DESC,\040lifetimes.base\040DESC\^A)\^ASELECT\040*\040FROM\040wknd\040where\040report_sunday\040=\040'2024-12-08'\040limit\0405;
ALTER\040TABLE\040forecast_app.dailies\^AADD\040COLUMN\040wknd_report_sunday\040DATE\040GENERATED\040ALWAYS\040AS\040(\^A\040\040\040\040CASE\^A\040\040\040\040\040\040\040\040WHEN\040EXTRACT(DOW\040FROM\040date)\040=\0400\040THEN\040date\^A\040\040\040\040\040\040\040\040ELSE\040date\040+\040(7\040-\040EXTRACT(DOW\040FROM\040date))\040*\040INTERVAL\040'1\040day'\^A\040\040\040\040END\^A)\040STORED;
CREATE\040INDEX\040idx_report_sunday\040\^AON\040forecast_app.dailies\040(\^A\040\040\040\040wknd_report_sunday\^A);
WITH\040week\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040MIN(week)\040AS\040week,\^A\040\040\040\040\040\040\040\040MAX(film_week)\040AS\040film_week,\^A\040\040\040\040\040\040\040\040wknd_report_sunday,\^A\040\040\040\040\040\040\040\040SUM(value)\040FILTER\040(WHERE\040is_weekend)\040AS\040wknd,\^A\040\040\040\040\040\040\040\040JSONB_OBJECT_AGG(to_char(date,\040'Dy')::text,\040value)\040AS\040dailies,\^A\040\040\040\040\040\040\040\040MAX(cume)\040AS\040cume,\^A\040\040\040\040\040\040\040\040MIN(cume\040-\040value)\040AS\040last_wknd_cume\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040true\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040date\040<=\040wknd_report_sunday\^A\040\040\040\040\040\040AND\040date\040>\040wknd_report_sunday\040+\040INTERVAL\040'-1\040week'\^A\040\040\040\040GROUP\040BY\040ter_id,\040primary_title_no,\040wknd_report_sunday\^A),\040\^Alast_week\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040SUM(value)\040FILTER\040(WHERE\040is_weekend)\040AS\040wknd\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040true\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040dailies.date\040<=\040wknd_report_sunday\040+\040INTERVAL\040'-1\040week'\^A\040\040\040\040\040\040AND\040dailies.date\040>\040wknd_report_sunday\040+\040INTERVAL\040'-2\040weeks'\^A\040\^A\040\040\040\040GROUP\040BY\040ter_id,\040primary_title_no,\040wknd_report_sunday\^A),\^Alifetimes\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040cume\040as\040base\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040is_lifetime\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\^A),\^Awknd\040AS\040(\^ASELECT\^AROW_NUMBER()\040OVER\040(PARTITION\040BY\040week.ter_id\^A\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040\040ORDER\040BY\040COALESCE(week.wknd,\0400)\040DESC,\040COALESCE(lifetimes.base,\0400))\040AS\040RANK,\^A\040\040\040\040week.ter_id,\^A\040\040\040\040week.primary_title_no,\^A\040\040\040\040week.wknd,\^A\040\040\040\040last_week.wknd\040AS\040last_wknd,\^A\040\040\040\040week.cume,\^A\040\040\040\040week.last_wknd_cume\040AS\040last_wknd_cume,\^A\040\040\040\040COALESCE(week.dailies->>'Mon',\040'0')::numeric\040AS\040MON,\^A\040\040\040\040COALESCE(week.dailies->>'Tue',\040'0')::numeric\040AS\040TUE,\^A\040\040\040\040COALESCE(week.dailies->>'Wed',\040'0')::numeric\040AS\040WED,\^A\040\040\040\040COALESCE(week.dailies->>'Thu',\040'0')::numeric\040AS\040THU,\^A\040\040\040\040COALESCE(week.dailies->>'Fri',\040'0')::numeric\040AS\040FRI,\^A\040\040\040\040COALESCE(week.dailies->>'Sat',\040'0')::numeric\040AS\040SAT,\^A\040\040\040\040COALESCE(week.dailies->>'Sun',\040'0')::numeric\040AS\040SUN,\^A\040\040\040\040COALESCE(lifetimes.base,\0400)\040AS\040life,\^A\040\040\040\040CONCAT('(',\040ARRAY_TO_STRING(ARRAY[\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040=\0401\040THEN\040'Mon'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0402\040THEN\040'Tue'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0403\040THEN\040'Wed'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0404\040THEN\040'Thu'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0405\040THEN\040'Fri'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0406\040THEN\040'Sat'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0407\040THEN\040'Sun'\040END\^A\040\040\040\040],\040',\040'),\040')')\040AS\040days_in_weekend,\^A\040\040\040\040week.week\040AS\040weeks_out,\^A\040\040\040\040week.film_week\040AS\040wk,\^A\040\040\040\040week.wknd_report_sunday\040AS\040report_sunday,\^A\040\040\040\040territory.country_name\040AS\040terr_name,\^A\040\040\040\040metadata.international_title,\^A\040\040\040\040metadata.title,\^A\040\040\040\040metadata.distributor,\^A\040\040\040\040rating,\040release_date\^AFROM\040week\^ALEFT\040JOIN\040last_week\040ON\040week.ter_id\040=\040last_week.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040last_week.primary_title_no\040\^AINNER\040JOIN\040common.territory_group\040ON\040week.ter_id\040=\040territory_group.ter_id\^AINNER\040JOIN\040common.territory\040ON\040territory.country_code\040=\040territory_group.ter_id\^AINNER\040JOIN\040lifetimes\040ON\040week.ter_id\040=\040lifetimes.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040lifetimes.primary_title_no\^ALEFT\040JOIN\040forecast_app.metadata\040ON\040week.ter_id\040=\040metadata.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040metadata.primary_title_no\^AWHERE\040territory.source\040=\040'flash'\^A\040\040AND\040territory_group.id\040=\040'GLOBAL'\^A\040\040\^AORDER\040BY\040week.wknd_report_sunday,\040week.ter_id,\040week.wknd\040DESC,\040lifetimes.base\040DESC\^A)\^ASELECT\040*\040FROM\040wknd\040where\040report_sunday\040=\040'2024-12-08'\040and\040ter_id\040=\040'UK';
CREATE\040OR\040REPLACE\040view\040forecast_app.wknd\040AS\040(\^AWITH\040week\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040MIN(week)\040AS\040week,\^A\040\040\040\040\040\040\040\040MAX(film_week)\040AS\040film_week,\^A\040\040\040\040\040\040\040\040wknd_report_sunday,\^A\040\040\040\040\040\040\040\040SUM(value)\040FILTER\040(WHERE\040is_weekend)\040AS\040wknd,\^A\040\040\040\040\040\040\040\040JSONB_OBJECT_AGG(to_char(date,\040'Dy')::text,\040value)\040AS\040dailies,\^A\040\040\040\040\040\040\040\040MAX(cume)\040AS\040cume,\^A\040\040\040\040\040\040\040\040MIN(cume\040-\040value)\040AS\040last_wknd_cume\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040true\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\040\040\040GROUP\040BY\040ter_id,\040primary_title_no,\040wknd_report_sunday\^A),\040\^Alast_week\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040wknd_report_sunday,\^A\040\040\040\040\040\040\040\040SUM(value)\040FILTER\040(is_weekend)\040AS\040wknd\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\040\040\040GROUP\040BY\040ter_id,\040primary_title_no,\040wknd_report_sunday\^A),\^Alifetimes\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040cume\040as\040base\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040is_lifetime\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\^A)\^ASELECT\^AROW_NUMBER()\040OVER\040(PARTITION\040BY\040week.wknd_report_sunday,\040week.ter_id\040ORDER\040BY\040COALESCE(week.wknd,\0400)\040DESC,\040COALESCE(lifetimes.base,\0400))\040AS\040rank,\^A\040\040\040\040week.ter_id,\^A\040\040\040\040week.primary_title_no\040as\040primary_title_n,\^A\040\040\040\040week.wknd,\^A\040\040\040\040last_week.wknd\040AS\040last_wknd,\^A\040\040\040\040week.cume,\^A\040\040\040\040week.last_wknd_cume\040AS\040last_wknd_cume,\^A\040\040\040\040COALESCE(week.dailies->>'Mon',\040'0')::numeric\040AS\040MON,\^A\040\040\040\040COALESCE(week.dailies->>'Tue',\040'0')::numeric\040AS\040TUE,\^A\040\040\040\040COALESCE(week.dailies->>'Wed',\040'0')::numeric\040AS\040WED,\^A\040\040\040\040COALESCE(week.dailies->>'Thu',\040'0')::numeric\040AS\040THU,\^A\040\040\040\040COALESCE(week.dailies->>'Fri',\040'0')::numeric\040AS\040FRI,\^A\040\040\040\040COALESCE(week.dailies->>'Sat',\040'0')::numeric\040AS\040SAT,\^A\040\040\040\040COALESCE(week.dailies->>'Sun',\040'0')::numeric\040AS\040SUN,\^A\040\040\040\040COALESCE(lifetimes.base,\0400)\040AS\040life,\^A\040\040\040\040CONCAT('(',\040ARRAY_TO_STRING(ARRAY[\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040=\0401\040THEN\040'Mon'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0402\040THEN\040'Tue'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0403\040THEN\040'Wed'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0404\040THEN\040'Thu'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0405\040THEN\040'Fri'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0406\040THEN\040'Sat'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0407\040THEN\040'Sun'\040END\^A\040\040\040\040],\040',\040'),\040')')\040AS\040days_in_weekend,\^A\040\040\040\040week.week\040AS\040weeks_out,\^A\040\040\040\040week.film_week\040AS\040wk,\^A\040\040\040\040week.wknd_report_sunday\040AS\040report_sunday,\^A\040\040\040\040territory.country_name\040AS\040terr_name,\^A\040\040\040\040metadata.international_title,\^A\040\040\040\040metadata.title,\^A\040\040\040\040metadata.distributor,\^A\040\040\040\040rating,\040release_date\^AFROM\040week\^AINNER\040JOIN\040common.territory_group\040ON\040week.ter_id\040=\040territory_group.ter_id\^AINNER\040JOIN\040common.territory\040ON\040territory.country_code\040=\040territory_group.ter_id\^ALEFT\040JOIN\040last_week\040ON\040last_week.wknd_report_sunday\040=\040week.wknd_report_sunday\040-\040'7\040days'::interval\040\^AAND\040week.ter_id\040=\040last_week.ter_id\040\^AAND\040week.primary_title_no\040=\040last_week.primary_title_no\040\^AINNER\040JOIN\040lifetimes\040ON\040week.ter_id\040=\040lifetimes.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040lifetimes.primary_title_no\^AINNER\040JOIN\040forecast_app.metadata\040ON\040week.ter_id\040=\040metadata.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040metadata.primary_title_no\^AWHERE\040territory.source\040=\040'flash'\^A\040\040AND\040territory_group.id\040=\040'GLOBAL'\040\^A\040\040AND\040week.wknd\040>\0400\^A);
CREATE\040OR\040REPLACE\040view\040forecast_app.wknd\040AS\040(\^AWITH\040week\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040MIN(week)\040AS\040week,\^A\040\040\040\040\040\040\040\040MAX(film_week)\040AS\040film_week,\^A\040\040\040\040\040\040\040\040wknd_report_sunday,\^A\040\040\040\040\040\040\040\040SUM(value)\040FILTER\040(WHERE\040is_weekend)\040AS\040wknd,\^A\040\040\040\040\040\040\040\040JSONB_OBJECT_AGG(to_char(date,\040'Dy')::text,\040value)\040AS\040dailies,\^A\040\040\040\040\040\040\040\040MAX(cume)\040AS\040cume,\^A\040\040\040\040\040\040\040\040MIN(cume\040-\040value)\040AS\040last_wknd_cume\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040true\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\040\040\040GROUP\040BY\040ter_id,\040primary_title_no,\040wknd_report_sunday\^A),\040\^Alast_week\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040wknd_report_sunday,\^A\040\040\040\040\040\040\040\040SUM(value)\040FILTER\040(where\040is_weekend)\040AS\040wknd\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\040\040\040GROUP\040BY\040ter_id,\040primary_title_no,\040wknd_report_sunday\^A),\^Alifetimes\040AS\040(\^A\040\040\040\040SELECT\040\^A\040\040\040\040\040\040\040\040ter_id,\^A\040\040\040\040\040\040\040\040primary_title_no,\^A\040\040\040\040\040\040\040\040cume\040as\040base\^A\040\040\040\040FROM\040forecast_app.dailies\^A\040\040\040\040WHERE\040is_lifetime\^A\040\040\040\040\040\040AND\040currency\040=\040'USD'\^A\040\040\040\040\040\040AND\040type\040IN\040(2,4)\^A\040\^A)\^ASELECT\^AROW_NUMBER()\040OVER\040(PARTITION\040BY\040week.wknd_report_sunday,\040week.ter_id\040ORDER\040BY\040COALESCE(week.wknd,\0400)\040DESC,\040COALESCE(lifetimes.base,\0400))\040AS\040rank,\^A\040\040\040\040week.ter_id,\^A\040\040\040\040week.primary_title_no\040as\040primary_title_n,\^A\040\040\040\040week.wknd,\^A\040\040\040\040last_week.wknd\040AS\040last_wknd,\^A\040\040\040\040week.cume,\^A\040\040\040\040week.last_wknd_cume\040AS\040last_wknd_cume,\^A\040\040\040\040COALESCE(week.dailies->>'Mon',\040'0')::numeric\040AS\040MON,\^A\040\040\040\040COALESCE(week.dailies->>'Tue',\040'0')::numeric\040AS\040TUE,\^A\040\040\040\040COALESCE(week.dailies->>'Wed',\040'0')::numeric\040AS\040WED,\^A\040\040\040\040COALESCE(week.dailies->>'Thu',\040'0')::numeric\040AS\040THU,\^A\040\040\040\040COALESCE(week.dailies->>'Fri',\040'0')::numeric\040AS\040FRI,\^A\040\040\040\040COALESCE(week.dailies->>'Sat',\040'0')::numeric\040AS\040SAT,\^A\040\040\040\040COALESCE(week.dailies->>'Sun',\040'0')::numeric\040AS\040SUN,\^A\040\040\040\040COALESCE(lifetimes.base,\0400)\040AS\040life,\^A\040\040\040\040CONCAT('(',\040ARRAY_TO_STRING(ARRAY[\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040=\0401\040THEN\040'Mon'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0402\040THEN\040'Tue'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0403\040THEN\040'Wed'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0404\040THEN\040'Thu'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0405\040THEN\040'Fri'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0406\040THEN\040'Sat'\040END,\^A\040\040\040\040\040\040\040\040CASE\040WHEN\040wknd_start_day\040<=\0407\040THEN\040'Sun'\040END\^A\040\040\040\040],\040',\040'),\040')')\040AS\040days_in_weekend,\^A\040\040\040\040week.week\040AS\040weeks_out,\^A\040\040\040\040week.film_week\040AS\040wk,\^A\040\040\040\040week.wknd_report_sunday\040AS\040report_sunday,\^A\040\040\040\040territory.country_name\040AS\040terr_name,\^A\040\040\040\040metadata.international_title,\^A\040\040\040\040metadata.title,\^A\040\040\040\040metadata.distributor,\^A\040\040\040\040rating,\040release_date\^AFROM\040week\^AINNER\040JOIN\040common.territory_group\040ON\040week.ter_id\040=\040territory_group.ter_id\^AINNER\040JOIN\040common.territory\040ON\040territory.country_code\040=\040territory_group.ter_id\^ALEFT\040JOIN\040last_week\040ON\040last_week.wknd_report_sunday\040=\040week.wknd_report_sunday\040-\040'7\040days'::interval\040\^AAND\040week.ter_id\040=\040last_week.ter_id\040\^AAND\040week.primary_title_no\040=\040last_week.primary_title_no\040\^AINNER\040JOIN\040lifetimes\040ON\040week.ter_id\040=\040lifetimes.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040lifetimes.primary_title_no\^AINNER\040JOIN\040forecast_app.metadata\040ON\040week.ter_id\040=\040metadata.ter_id\040\^A\040\040\040\040AND\040week.primary_title_no\040=\040metadata.primary_title_no\^AWHERE\040territory.source\040=\040'flash'\^A\040\040AND\040territory_group.id\040=\040'GLOBAL'\040\^A\040\040AND\040week.wknd\040>\0400\^A);
ANALYZE\040forecast_app.dailies;
\134d+\040forecast_app.dailies
ALTER\040TABLE\040\^A\040\040forecast_app.dailies\040\^AADD\040\^A\040\040COLUMN\040wknd_report_sunday\040DATE\040GENERATED\040ALWAYS\040AS\040(\^A\040\040\040\040CASE\040WHEN\040EXTRACT(\^A\040\040\040\040\040\040DOW\040\^A\040\040\040\040\040\040FROM\040\^A\040\040\040\040\040\040\040\040date\^A\040\040\040\040)\040=\0400\040THEN\040date\040ELSE\040date\040+\040(\^A\040\040\040\040\040\0407\040-\040EXTRACT(\^A\040\040\040\040\040\040\040\040DOW\040\^A\040\040\040\040\040\040\040\040FROM\040\^A\040\040\040\040\040\040\040\040\040\040date\^A\040\040\040\040\040\040)\^A\040\040\040\040)\040*\040INTERVAL\040'1\040day'\040END\^A\040\040)\040STORED;
\134d+\040forecast_app.dailies;
SELECT    totals.primary_title_no,    totals.day,    totals.day_gross,    totals.day_admissions,    totals.day_gross / totals.day_admissions AS ticket_priceFROM    intl.transaction_day_totals totalsINNER JOIN forecast_app.metadata ts    ON totals.primary_title_no = ts.primary_title_no    AND totals.ter_id = ts.ter_idWHERE    totals.ter_id = 'DE'    AND totals.day_gross > 0    AND totals.day_admissions > 0    AND totals.day <= '2025-06-03'::date    AND totals.day >= ts.release_dateORDER BY    totals.day DESC;
SELECT    count(*)FROM    intl.transaction_day_totals totalsINNER JOIN forecast_app.metadata ts    ON totals.primary_title_no = ts.primary_title_no    AND totals.ter_id = ts.ter_idWHERE    totals.ter_id = 'DE'    AND totals.day_gross > 0    AND totals.day_admissions > 0    AND totals.day <= '2025-06-03'::date    AND totals.day >= ts.release_dateORDER BY    totals.day DESC;
SELECT count(*) from (SELECT    totals.primary_title_no,    totals.day,    totals.day_gross,    totals.day_admissions,    -- totals.day_gross / totals.day_admissions AS ticket_priceFROM    intl.transaction_day_totals totalsINNER JOIN forecast_app.metadata ts    ON totals.primary_title_no = ts.primary_title_no    AND totals.ter_id = ts.ter_idWHERE    totals.ter_id = 'DE'    AND totals.day_gross > 0    AND totals.day_admissions > 0    AND totals.day <= '2025-06-03'::date    AND totals.day >= ts.release_dateORDER BY    totals.day DESC) foo;
SELECT count(*) from (SELECT    totals.primary_title_no,    totals.day,    totals.day_gross,    totals.day_admissions,    -- totals.day_gross / totals.day_admissions AS ticket_priceFROM    intl.transaction_day_totals totalsINNER JOIN forecast_app.metadata ts    ON totals.primary_title_no = ts.primary_title_no    AND totals.ter_id = ts.ter_idWHERE    totals.ter_id = 'DE'    AND totals.day_gross > 0    AND totals.day_admissions > 0    AND totals.day <= '2025-06-03'::date    AND totals.day >= ts.release_date) foo;
begin-- DB: v2_gowerstDROP TABLE IF EXISTS forecast_app.weekly_report CASCADE;DROP TABLE IF EXISTS forecast_app.weekly_report_admits CASCADE;DROP TABLE IF EXISTS forecast_app.lifetimes CASCADE;DROP TABLE IF EXISTS forecast_app.lifetimes_admits CASCADE;
rollbackbeginDROP TABLE IF EXISTS forecast_app.weekly_report CASCADE;DROP TABLE IF EXISTS forecast_app.weekly_report_admits CASCADE;DROP TABLE IF EXISTS forecast_app.lifetimes CASCADE;DROP TABLE IF EXISTS forecast_app.lifetimes_admits CASCADE;
rollback;
begin;
DROP TABLE IF EXISTS forecast_app.weekly_report CASCADE;DROP TABLE IF EXISTS forecast_app.weekly_report_admits CASCADE;DROP TABLE IF EXISTS forecast_app.lifetimes CASCADE;DROP TABLE IF EXISTS forecast_app.lifetimes_admits CASCADE;
commit;
\d+ forecast_app.weekly_report
\d+ forecast_app.weekly_report_admits
\d+ forecast_app.lifetimes
\d+ forecast_app.lifetimes_admits
